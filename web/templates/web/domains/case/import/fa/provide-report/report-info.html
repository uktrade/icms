{% extends "flow/task-base.html" %}
{% import "forms/forms.html" as forms %}
{% import "forms/fields.html" as fields %}
{% from "display/fields.html" import application_field %}

{% block sidebar %}{% endblock %}

{% block content_actions %}
  <div class="content-actions">
    <ul class="menu-out flow-across">
      <li>
        <a href="{{ icms_url('workbasket') }}" class="prev-link">
          Workbasket
        </a>
      </li>
    </ul>
  </div>
{% endblock %}

{% block main_content %}
  {% if process.supplementary_info.is_complete %}
    <div class="info-box info-box-info">
      Use the Reopen button if you have more information to report on this application.
    </div>

    {% call forms.form(
      action=icms_url('import:fa:reopen-report', kwargs={'application_pk': process.pk}),
      method="post",
      csrf_input=csrf_input,
      id="id-reopen_report") -%}
      <button type="submit" class="secondary-button button" for="id-reopen_report">
        Reopen
      </button>
    {% endcall %}
    <div class="section-break"></div>
  {% endif %}

  <h3>Details of who bought from</h3>
  {% with can_delete = True, read_only = process.supplementary_info.is_complete %}
    {% include "partial/import-contacts/list.html" %}
  {% endwith %}

  {% with reports = process.supplementary_info.reports.all(), read_only = process.supplementary_info.is_complete or not process.importcontact_set.exists() %}
    {% include "web/domains/case/import/fa/partials/report-list.html" %}
  {% endwith %}

  <div class="section-break"></div>
  <h3>Complete Supplementary Reporting</h3>
  <div class="section-break"></div>

  {% if process.supplementary_info.is_complete %}
    {{ application_field(process.supplementary_info.completed_by, "Report Completed By") }}
    {{ application_field(process.supplementary_info.completed_datetime.strftime('%d-%b-%Y'), "Date Reporting Completed") }}
  {% else %}
    <div class="info-box info-box-info">
      You must provide the details of who you bought the items from and one or more firearms
      reports before you can complete reporting. Each report must include the means of transport,
      the date the firearms were received and the details of who you bought the items from.
      Once reporting has been completed you will still be able to access and update the reports from your application.
    </div>

    <div class="modal-popover-container hidden">
      <div class="modal-popover regular-popover" tabindex="0">
        <div class="modal-popover-content">
          <h2 id="engine-modal-popover-title">Complete Supplementary Reporting Information</h2>
          <p>
            You should only complete reporting if you have provided the details of who you bought
            the items from and goods that will be imported against this licence. Do you want to complete reporting?
          </p>
          {% call forms.form(action='', method='post', csrf_input=csrf_input) -%}
            <ul class="menu-out modal-popover-actions flow-across">
              <li>
                <button type="submit" class="primary-button button">
                  Confirm
                </button>
              </li>
              <li>
                <button type="button" onclick="$('.modal-popover-container').hide()" class="link-button button">
                  Cancel
                </button>
              </li>
            </ul>
          {%- endcall %}
        </div>
      </div>
    </div>

    <button type="button" onclick="$('.modal-popover-container').show()" class="button primary-button">
      Confirm Reporting Complete
    </button>
  {% endif %}
{% endblock %}
