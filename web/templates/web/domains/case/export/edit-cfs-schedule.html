{% extends "flow/task-base.html" %}
{% import "forms/fields.html" as fields %}
{% from "display/fields.html" import application_section, application_field %}

{% block sidebar %}
  {% include "partial/case/export/cfs/sidebar.html" %}
{% endblock %}

{% block css %}
  {{ form.media.css }}
{% endblock %}

{% block content_actions %}
  <div class="content-actions">
    <ul class="menu-out flow-across">
      <li>
        <a
          href="{{ icms_url('export:cfs-edit', kwargs={'application_pk': process.pk}) }}"
          class="prev-link">
          Edit application
        </a>
      </li>
    </ul>
  </div>
{% endblock %}

{% block form_content %}
  {{ fields.field(form.exporter_status) }}
  {{ fields.field(form.brand_name_holder) }}
  {{ fields.field(form.legislations) }}
  {{ fields.field(form.product_eligibility) }}
  {{ fields.field(form.goods_placed_on_uk_market) }}
  {{ fields.field(form.goods_export_only) }}
  {{ fields.field(form.any_raw_materials) }}

  <div id="final-product-end-use-wrapper">
    {{ fields.field(form.final_product_end_use) }}
  </div>

  {{ fields.field(form.country_of_manufacture) }}
  {{ fields.field(form.schedule_statements, checkbox_label="These products are manufactured in accordance with the Good Manufacturing Practice standards set out in UK law") }}
{% endblock %}


{% block task_actions %}
  <li>
    <button type="submit" role="action-button" name="edit_schedule" class="primary-button button">
      Save
    </button>
  </li>
{% endblock %}

{% block subtasks %}
  <h4>Manufactured At</h4>
  <div class="info-box info-box-info">
    If you have chosen the 'Exporter Status' 'I am the manufacturer' then you should not complete this information
    unless you wish to include details of your contract manufacturer. Applicants who have chosen
    'I am not the manufacturer' may enter details of the manufacturer in this section.
  </div>

  {% if not schedule.manufacturer_name %}
    <p>Optionally include manufacturer information on the issued certificate schedule</p>
    <a class="button small-button icon-plus"
       href="{{ icms_url('export:cfs-schedule-set-manufacturer', kwargs={'application_pk': process.pk, 'schedule_pk': schedule.pk}) }}">Add
      Manufacturer</a>
  {% else %}
    {% call application_section("Manufacturer Address") %}
      {{ application_field(schedule.manufacturer_name, "Name") }}
      {{ application_field(schedule.manufacturer_postcode, "Postcode") }}
      {{ application_field((schedule.manufacturer_address or "") |nl2br, "Address") }}
    {% endcall %}
    <a class="button small-button icon-pencil"
       href="{{ icms_url('export:cfs-schedule-set-manufacturer', kwargs={'application_pk': process.pk, 'schedule_pk': schedule.pk}) }}">Edit
      Manufacturer</a>
    <form
      method="post"
      action="{{ icms_url('export:cfs-schedule-delete-manufacturer', kwargs={'application_pk': process.pk, 'schedule_pk': schedule.pk}) }}"
      class="form-inline">
      {{ csrf_input }}
      <button
        type="submit"
        class="button small-button icon-bin"
      >Remove Manufacturer
      </button>
    </form>
  {% endif %}

  {% if has_legislation %}
    <h4>Products</h4>
    <div class="info-box info-box-info">
      <p>Please add product information below. A separate line is required for each product.</p>
      <p><strong>
        If any of the information given on this schedule does not apply to all of the products below,
        a separate schedule must be added for the products where the information is different.
      </strong></p>
      <p>
        To upload products in bulk, download and complete the template provided below.
        Once uploaded the products list will be filled out automatically.
      </p>
    </div>
    {% if products %}
    <table class="setoutList">
      <thead>
        <tr>
          <th scope="col">Product Name</th>
          {% if is_biocidal %}
            <th scope="col">Product Type Numbers</th>
            <th scope="col">Active Ingredients</th>
          {% endif %}
          <th scope="col">Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for product in products %}
        <tr>
          <td>{{ product.product_name }}</td>
          {% if is_biocidal %}
            <td>
              <table class="nestedListWithHeader setoutList nestedList">
                <thead>
                  <tr>
                    <th scope="col">Number</th>
                  </tr>
                </thead>
                <tbody>
                {% for product_type in product.product_type_numbers.all() %}
                  <tr>
                    <td>{{ product_type.product_type_number }}</td>
                  </tr>
                {% endfor %}
                </tbody>
              </table>
            </td>
            <td>
              <table class="nestedListWithHeader setoutList nestedList">
                <thead>
                  <tr>
                    <th scope="col">Name</th>
                    <th scope="col">CAS Number</th>
                  </tr>
                </thead>
                <tbody>
                  {% for ingredient in product.active_ingredients.all() %}
                  <tr>
                    <td>{{ ingredient.name }}</td>
                    <td>{{ ingredient.cas_number }}</td>
                  </tr>
                  {% endfor %}
              </table>
            </td>
          {% endif %}
          <td>
            <ul class="menu-out">
              <li>
                <a
                  href="{{ icms_url('export:cfs-schedule-edit-product', kwargs={'application_pk': process.pk, 'schedule_pk': schedule.pk, 'product_pk': product.pk }) }}"
                  class="button link-button icon-pencil">
                Edit
                </a>
              </li>
              <li>
                <form
                  method="post"
                  action="{{ icms_url('export:cfs-schedule-delete-product', kwargs={'application_pk': process.pk, 'schedule_pk': schedule.pk, 'product_pk': product.pk }) }}"
                  class="form-inline">
                  {{ csrf_input }}
                  <button type="submit" class="button link-button icon-bin">
                    Delete
                  </button>
                </form>
              </li>
            </ul>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    {% endif %}
    <a
      href="{{ icms_url('export:cfs-schedule-add-product', kwargs={'application_pk': process.pk, 'schedule_pk': schedule.pk }) }}"
      class="button small-button icon-plus">
      Add Product
    </a>
  {% endif %}
{% endblock %}

{% block page_js %}
  {{ form.media.js }}
  <script src="{{ static('web/js/pages/cfs-schedule-edit.js') }}" type="text/javascript"></script>
{% endblock %}
